<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeopardy Drinking Game</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<!-- Player input section -->
<div id="player-setup" class="player-setup">
    <h1>Enter Player Names (2-4 Players)</h1>
    <form id="player-form">
        <input type="text" id="player1" placeholder="Player 1" required>
        <input type="text" id="player2" placeholder="Player 2" required>
        <input type="text" id="player3" placeholder="Player 3 (optional)">
        <input type="text" id="player4" placeholder="Player 4 (optional)">
        <button type="submit">Start Game</button>
    </form>
</div>

<!-- Game section -->
<div id="game-section" class="hidden">
    <div class="game-container">
        <!-- Player display section -->
        <div id="player-display" class="player-display">
            <h2>Players</h2>
            <ul id="player-list"></ul> <!-- Dynamically show the players and their scores -->
        </div>

        <!-- Game board section -->
        <div class="board-container">
            <h2 id="current-player"></h2>
            <div id="jeopardy-board" class="jeopardy-board">
                <!-- Game board will be dynamically generated here -->
            </div>
        </div>
    </div>

    <!-- Question modal -->
    <div id="question-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h1 id="question-text"></h1>
            <div id="timer-container">
                <span>Time left: <span id="timer">30</span> seconds</span>
            </div>
            <div id="multiple-choice" class="button-container"></div> <!-- Buttons for "Answered" and "I Don't Know" -->
            <button id="close-modal">Close</button>
        </div>
    </div>
</div>

<script>
    let players = []; // Array to hold player objects {name, score}
    let currentPlayerIndex = 0; // To keep track of whose turn it is
    let correctAnswer = ''; // To store the correct answer for each question
    let timer; // Reference to the countdown timer
    let countdownInterval; // Reference to the countdown interval
    const categories = {{ categories | tojson }};  // Injected from Flask (categories)

    // Function to update the displayed current player
    function updateCurrentPlayer() {
        document.getElementById('current-player').innerText = `Current Player: ${players[currentPlayerIndex].name}`;
    }

    // Function to update the player scores display
    function updatePlayerDisplay() {
        const playerList = document.getElementById('player-list');
        playerList.innerHTML = ''; // Clear previous player data

        players.forEach(player => {
            const li = document.createElement('li');
            li.innerText = `${player.name}: ${player.score} Drink${player.score > 1 ? 's' : ''}`;
            playerList.appendChild(li);
        });
    }

    // Function to handle player input and start the game
    document.getElementById('player-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the form from submitting

        // Get player names
        const player1 = document.getElementById('player1').value.trim();
        const player2 = document.getElementById('player2').value.trim();
        const player3 = document.getElementById('player3').value.trim();
        const player4 = document.getElementById('player4').value.trim();

        // Add the players to the players array with initial scores
        players.push({name: player1, score: 0});
        players.push({name: player2, score: 0});
        if (player3) players.push({name: player3, score: 0});
        if (player4) players.push({name: player4, score: 0});

        // Hide the player setup section and show the game board
        document.getElementById('player-setup').style.display = 'none';
        document.getElementById('game-section').style.display = 'block';

        // Set the first player and display player scores
        updateCurrentPlayer();
        updatePlayerDisplay();

        // Generate the game board with categories
        generateGameBoard();
    });

    // Function to generate the game board with categories and tiles
    function generateGameBoard() {
        const board = document.getElementById('jeopardy-board');
        board.innerHTML = '';  // Clear any previous board

        categories.forEach(category => {
            const categoryColumn = document.createElement('div');
            categoryColumn.classList.add('category-column');

            // Add the category name
            const categoryHeader = document.createElement('div');
            categoryHeader.classList.add('category');
            categoryHeader.innerText = category;
            categoryColumn.appendChild(categoryHeader);

            // Add 5 questions per category (1 Drink - 5 Drinks based on difficulty)
            for (let difficulty = 1; difficulty <= 5; difficulty++) {
                const questionTile = document.createElement('div');
                questionTile.classList.add('question');
                questionTile.setAttribute('id', `${category}-difficulty-${difficulty}`);
                questionTile.setAttribute('data-category', category);
                questionTile.setAttribute('data-difficulty', difficulty);
                questionTile.setAttribute('data-value', difficulty);  // Drinks based on difficulty
                questionTile.innerText = `${difficulty} Drink${difficulty > 1 ? 's' : ''}`;

                // Add event listener for click event
                questionTile.addEventListener('click', handleQuestionClick);

                categoryColumn.appendChild(questionTile);
            }

            board.appendChild(categoryColumn);
        });
    }

    function handleQuestionClick(event) {
        const item = event.target;
        const category = encodeURIComponent(item.getAttribute('data-category'));  // Make sure category is URL-safe
        const difficulty = item.getAttribute('data-difficulty');  // Drink value (1 to 5)
        const questionId = item.getAttribute('id');
        const questionValue = parseInt(item.getAttribute('data-value'), 10);

        console.log(`Clicked tile: ${questionId}`);  // Debugging info

        // Fetch and display the trivia question with both category and difficulty
        fetchTriviaQuestion(category, difficulty, questionId, questionValue);
    }


    function fetchTriviaQuestion(category, difficulty, questionId, questionValue) {
        fetch(`/get_questions/${category}/${difficulty}`)  // Fetch question based on category and difficulty
            .then(response => response.json())
            .then(data => {
                console.log("Fetched Question Data: ", data);

                // If no data (empty response or None returned from backend), notify or skip
                if (!data || data.length === 0) {
                    console.error(`No question found for category: ${category}, difficulty: ${difficulty}`);
                    return; // Exit without displaying the modal
                }

                const questionData = data[0];  // Get the first question (we only expect one)

                // Display the question in the modal
                document.getElementById('question-text').innerText = questionData.correct_answer;

                // Clear previous buttons
                const multipleChoiceContainer = document.getElementById('multiple-choice');
                multipleChoiceContainer.innerHTML = '';

                // Create "I've Answered" and "I Don't Know" buttons initially
                const answeredButton = document.createElement('button');
                answeredButton.innerText = "I've Answered";
                answeredButton.onclick = function() {
                    // Show the correct answer and change buttons to "Correct" and "Incorrect"
                    checkAnswer(questionData.question, questionId, questionValue);
                };

                const dontKnowButton = document.createElement('button');
                dontKnowButton.innerText = "I Don't Know";
                dontKnowButton.onclick = function() {
                    handleIncorrect(questionId, questionValue);  // Handle incorrect answer
                };

                multipleChoiceContainer.appendChild(answeredButton);
                multipleChoiceContainer.appendChild(dontKnowButton);

                // Show the modal and start the countdown timer
                document.getElementById('question-modal').style.display = 'flex';
                startTimer(questionId, questionValue);  // Start the 30-second timer
            })
            .catch(error => {
                console.error(`Error fetching questions for category ${category}:`, error);
            });
    }

    function checkAnswer(correctAnswer, questionId, questionValue) {
        const currentPlayer = players[currentPlayerIndex];

        // Stop the timer
        clearInterval(countdownInterval);
        clearTimeout(timer);

        // Show the correct answer
        document.getElementById('question-text').innerText = `The correct answer is: ${correctAnswer}`;

        // Change buttons to "Correct" and "Incorrect"
        const multipleChoiceContainer = document.getElementById('multiple-choice');
        multipleChoiceContainer.innerHTML = '';  // Clear current buttons

        const correctButton = document.createElement('button');
        correctButton.innerText = "Correct";
        correctButton.onclick = function() {
            // Handle correct answer
            const questionTile = document.getElementById(questionId);
            questionTile.style.backgroundColor = 'green';  // Mark as correct
            questionTile.style.cursor = 'not-allowed';  // Disable further clicks
            questionTile.removeEventListener('click', handleQuestionClick);  // Disable click

            // Update player score
            currentPlayer.score += questionValue;
            updatePlayerDisplay();

            // Move to the next player and close the modal
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            updateCurrentPlayer();
            closeModal();
        };

        const incorrectButton = document.createElement('button');
        incorrectButton.innerText = "Incorrect";
        incorrectButton.onclick = function() {
            handleIncorrect(questionId, questionValue);  // Treat as incorrect answer
        };

        multipleChoiceContainer.appendChild(correctButton);
        multipleChoiceContainer.appendChild(incorrectButton);
    }


    function handleIncorrect(questionId, questionValue) {
        const currentPlayer = players[currentPlayerIndex];

        // Stop the timer
        clearInterval(countdownInterval);
        clearTimeout(timer);

        // Mark the question as incorrect
        const questionTile = document.getElementById(questionId);
        questionTile.style.backgroundColor = 'red';  // Mark as incorrect
        questionTile.style.cursor = 'not-allowed';  // Disable further clicks
        questionTile.removeEventListener('click', handleQuestionClick);  // Disable click

        // Update player score (subtract points)
        currentPlayer.score -= questionValue;
        updatePlayerDisplay();

        // Move to the next player
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
        updateCurrentPlayer();

        // Close the modal after incorrect
        closeModal();
    }

    // Function to close the modal and return to the game board
    function closeModal() {
        document.getElementById('question-modal').style.display = 'none';  // Hide the modal
        clearInterval(countdownInterval);  // Stop the countdown
        clearTimeout(timer);  // Stop the timer if running
    }

    // Initialize event listeners after DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('close-modal').addEventListener('click', closeModal);
    });

    // Function to start the 30-second countdown timer
    function startTimer(questionId, questionValue) {
        let timeLeft = 30; // 30 seconds
        document.getElementById('timer').innerText = timeLeft; // Display initial time

        countdownInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft >= 0) {
                document.getElementById('timer').innerText = timeLeft;
            } else {
                clearInterval(countdownInterval); // Stop the interval when time runs out
            }
        }, 1000);

        // Automatically mark the question as incorrect after 30 seconds
        timer = setTimeout(() => {
            console.log('Time ran out!');

            const currentPlayer = players[currentPlayerIndex];
            currentPlayer.score -= questionValue; // Subtract drinks from player's score if time runs out

            // Mark the question as incorrect
            const questionTile = document.getElementById(questionId);
            questionTile.style.backgroundColor = 'red';
            questionTile.style.cursor = 'not-allowed'; // Disable further clicks
            questionTile.removeEventListener('click', handleQuestionClick); // Disable click

            // Update player display and current player
            updatePlayerDisplay();
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length; // Cycle through players
            updateCurrentPlayer();

            // Close the modal when time runs out
            closeModal();
        }, 30000); // 30 seconds
    }
</script>
</body>
</html>
